<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<!--                                             -->
<!-- Author: ROOT team (rootdev@hpsalo.cern.ch)  -->
<!--                                             -->
<!--   Date: Fri Dec 20 16:03:21 2002            -->
<!--                                             -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>TPoissonConsistency - source file</title>
<link rev=made href="mailto:rootdev@root.cern.ch">
<meta name="rating" content="General">
<meta name="objecttype" content="Manual">
<meta name="keywords" content="software development, oo, object oriented, unix, x11, windows, c++, html, rene brun, fons rademakers">
<meta name="description" content="ROOT - An Object Oriented Framework For Large Scale Data Analysis.">
</head>
<body BGCOLOR="#ffffff" LINK="#0000ff" VLINK="#551a8b" ALINK="#ff0000" TEXT="#000000">
<a name="TopOfPage"></a>
<pre>
<b>//////////////////////////////////////////////////////////////////////////</b>
<b>//                                                                      //</b>
<b>// <a href=".././TPoissonConsistency.html">TPoissonConsistency</a>			    				//</b>
<b>//                                                                      //</b>
<b>// Poissonian consistency						//</b>
<b>//                                                                      //</b>
<b>// Author: Marcel Kunze, RUB, Nov. 99					//</b>
<b>// Copyright (C) 1999-2001, Ruhr-University Bochum.			//</b>
<b>//                                                                      //</b>
<b>//////////////////////////////////////////////////////////////////////////</b>

#include "RhoMath/TPoissonConsistency.h"

#include &lt;assert.h&gt;
#include &lt;math.h&gt; 
#include &lt;stdlib.h&gt;

#include "RhoMath/TNumRecipes.h"
#include "RhoMath/TGaussConsistency.h"

static Double_t EPS_CONVERGE = 0.01;

ClassImp(TPoissonConsistency)

TBuffer &amp;operator&gt;&gt;(TBuffer &amp;buf, TPoissonConsistency *&amp;obj)
{
   obj = (TPoissonConsistency *) buf.ReadObject(TPoissonConsistency::Class());
   return buf;
}

#include &lt;iostream&gt;
using namespace std;

<a name="TPoissonConsistency:TPoissonConsistency"> </a>TPoissonConsistency::TPoissonConsistency(Int_t nObs, Double_t mu) 
: fNObs(nObs), fMu(mu)  
{ 
    if ( fMu &gt; 0 &amp;&amp; fNObs &gt;= 0 ) { // idiot check
	if (nObs &lt; mu) {
	    fSign = TConsistency::left;
	}
	if (nObs &gt; mu) {
	    fSign = TConsistency::right;
	}
	Calc();
    } else {
	fValue = fLikelihood = 0;
	SetStatus(TConsistency::underFlow);
    }
}

void 
<a name="TPoissonConsistency:Calc"> </a>TPoissonConsistency::Calc() 
{
    Double_t logMu = log( fMu ) ;
    
<b>    // get the likelihood - P(<a href=".././TPoissonConsistency.html#TPoissonConsistency:fNObs">fNObs</a>;mu)</b>
    <a href=".././TConsistency.html#TConsistency:fLikelihood">fLikelihood</a> = <a href="#TPoissonConsistency:GetLikelihood">GetLikelihood</a>( <a href=".././TPoissonConsistency.html#TPoissonConsistency:fNObs">fNObs</a>, <a href=".././TPoissonConsistency.html#TPoissonConsistency:fMu">fMu</a>, logMu ) ;
    
    if ( <a href=".././TConsistency.html#TConsistency:fLikelihood">fLikelihood</a> == 0 ) {
<b>	// looks like we are too far from peak</b>
	<a href=".././TConsistency.html#TConsistency:fValue">fValue</a> = 0 ;
	return ; 
    }
    
<b>    // the number can be adjusted</b>
    if ( TMath::Abs( <a href=".././TPoissonConsistency.html#TPoissonConsistency:fNObs">fNObs</a> - <a href=".././TPoissonConsistency.html#TPoissonConsistency:fMu">fMu</a> ) &lt; 50 ) {
	
	<a href="#TPoissonConsistency:CalcDirectSum">CalcDirectSum</a>() ;
	
    } else if ( <a href=".././TPoissonConsistency.html#TPoissonConsistency:fMu">fMu</a> &gt; 200 ) {
	
<b>	// gaussian is good for very big numbers only</b>
	<a href="#TPoissonConsistency:CalcGauss">CalcGauss</a>() ;
	
    } else {
	
<b>	// Gauss approximation is NOT good enough</b>
	<a href="#TPoissonConsistency:CalcTails">CalcTails</a>( logMu );
	
    }
    
    SetStatus(<a href=".././TConsistency.html#TConsistency:OK">TConsistency::OK</a>);
}


<a href="../ListOfTypes.html#Double_t">Double_t</a>
<a name="TPoissonConsistency:GetLikelihood"> </a><a href=".././TPoissonConsistency.html#TPoissonConsistency:GetLikelihood">TPoissonConsistency::GetLikelihood</a>( <a href="../ListOfTypes.html#Int_t">Int_t</a> n, <a href="../ListOfTypes.html#Double_t">Double_t</a> mu, <a href="../ListOfTypes.html#Double_t">Double_t</a> logMu ) const
{
    return exp(-mu+n*logMu-<a href=".././TNumRecipes.html#TNumRecipes:Gammln">TNumRecipes::Gammln</a>(n+1));
}

<a href="../ListOfTypes.html#void">void</a> 
<a name="TPoissonConsistency:CalcGauss"> </a><a href=".././TPoissonConsistency.html#TPoissonConsistency:CalcGauss">TPoissonConsistency::CalcGauss</a>()
{  
    
    <a href=".././TGaussConsistency.html">TGaussConsistency</a> cons(<a href=".././TPoissonConsistency.html#TPoissonConsistency:fNObs">fNObs</a>-<a href=".././TPoissonConsistency.html#TPoissonConsistency:fMu">fMu</a>,sqrt(<a href=".././TPoissonConsistency.html#TPoissonConsistency:fMu">fMu</a>));
    <a href=".././TConsistency.html#TConsistency:fValue">fValue</a> = cons.SignificanceLevel();
    
}


<a href="../ListOfTypes.html#void">void</a>
<a name="TPoissonConsistency:CalcDirectSum"> </a><a href=".././TPoissonConsistency.html#TPoissonConsistency:CalcDirectSum">TPoissonConsistency::CalcDirectSum</a>()
{
    
<b>    // simply count all P(i) which &gt; <a href=".././TConsistency.html#TConsistency:fLikelihood">fLikelihood</a></b>
<b>    // the algorithm is rather simple, but may be slow for big numbers,</b>
<b>    // so I limit it only for small differences between <a href=".././TPoissonConsistency.html#TPoissonConsistency:fNObs">fNObs</a> and <a href=".././TPoissonConsistency.html#TPoissonConsistency:fMu">fMu</a></b>
    
    <a href="../ListOfTypes.html#Double_t">Double_t</a> P_current = <a href=".././TConsistency.html#TConsistency:fLikelihood">fLikelihood</a> ;
    <a href="../ListOfTypes.html#Double_t">Double_t</a> significance = 1. ;
    <a href="../ListOfTypes.html#int">int</a> n = <a href=".././TPoissonConsistency.html#TPoissonConsistency:fNObs">fNObs</a> ;
    if ( <a href=".././TPoissonConsistency.html#TPoissonConsistency:fNObs">fNObs</a> &lt;= <a href=".././TPoissonConsistency.html#TPoissonConsistency:fMu">fMu</a> ) {
	<a href="../ListOfTypes.html#Double_t">Double_t</a> P_next = P_current * <a href=".././TPoissonConsistency.html#TPoissonConsistency:fMu">fMu</a> / (n+1) ;
	while ( P_next &gt; <a href=".././TConsistency.html#TConsistency:fLikelihood">fLikelihood</a> ) {
	    significance -= P_next ;
	    P_current = P_next ;
	    n ++ ;
	    P_next = P_current * <a href=".././TPoissonConsistency.html#TPoissonConsistency:fMu">fMu</a> / (n+1) ;
	}
    } else {                              // no, need go down
	while ( n &gt; 0 ) {                  // at max to zero
	    <a href="../ListOfTypes.html#Double_t">Double_t</a> P_next = P_current / <a href=".././TPoissonConsistency.html#TPoissonConsistency:fMu">fMu</a> * n ;     // get P(I-1)
	    if ( P_next &gt; <a href=".././TConsistency.html#TConsistency:fLikelihood">fLikelihood</a> ) {
		significance -= P_next ;
		P_current = P_next ;
		n -- ;
	    } else {
		break ;                        // finish at first which is &lt;= P(N)
	    }
	}
    }
    
    <a href=".././TConsistency.html#TConsistency:fValue">fValue</a> = significance ;
}


<a href="../ListOfTypes.html#void">void</a> 
<a name="TPoissonConsistency:CalcTails"> </a><a href=".././TPoissonConsistency.html#TPoissonConsistency:CalcTails">TPoissonConsistency::CalcTails</a>( <a href="../ListOfTypes.html#Double_t">Double_t</a> logMu )
{
    
<b>    // find the bin on the other side of peak - we need the bin which has P(i) &gt; P(<a href=".././TPoissonConsistency.html#TPoissonConsistency:fNObs">fNObs</a>)</b>
    <a href="../ListOfTypes.html#int">int</a> otherN = <a href="../ListOfTypes.html#int">int</a>(2*<a href=".././TPoissonConsistency.html#TPoissonConsistency:fMu">fMu</a> - <a href=".././TPoissonConsistency.html#TPoissonConsistency:fNObs">fNObs</a>) ;
    if ( otherN &lt; 0 ) otherN = 0 ; 
    
<b>    // Now wander around to find exact position</b>
    <a href="../ListOfTypes.html#Double_t">Double_t</a> otherL = <a href="#TPoissonConsistency:GetLikelihood">GetLikelihood</a>( otherN, <a href=".././TPoissonConsistency.html#TPoissonConsistency:fMu">fMu</a>, logMu ) ;
    
    <a href="../ListOfTypes.html#int">int</a> direction = 0 ;
    if ( otherN &gt; <a href=".././TPoissonConsistency.html#TPoissonConsistency:fMu">fMu</a> ) {
	if ( otherL &lt; <a href=".././TConsistency.html#TConsistency:fLikelihood">fLikelihood</a> ) {
	    direction = -1 ;
	} else {
	    direction = +1 ;
	} 
    } else { 
	if ( otherL &lt; <a href=".././TConsistency.html#TConsistency:fLikelihood">fLikelihood</a> ) {
	    direction = +1 ;
	} else {
	    direction = -1 ;
	} 
    }
    
    
<b>    // we need to find such N that P(N) &gt; _ likelihood and </b>
<b>    // ( P(N+1) &lt;= <a href=".././TConsistency.html#TConsistency:fLikelihood">fLikelihood</a> or P(N-1) &lt;= <a href=".././TConsistency.html#TConsistency:fLikelihood">fLikelihood</a> )</b>
    while ( kTRUE ) {
	<a href="../ListOfTypes.html#int">int</a> nextN = otherN + direction ;
	if ( nextN &lt; 0 ) {
<b>	    // this can happen only if we are at 0 already but need to go </b>
<b>	    // even futher - we can't - stop here</b>
	    break ;
	}
	<a href="../ListOfTypes.html#Double_t">Double_t</a> nextL = direction &gt; 0 ? otherL * <a href=".././TPoissonConsistency.html#TPoissonConsistency:fMu">fMu</a> / (otherN+1) : otherL / <a href=".././TPoissonConsistency.html#TPoissonConsistency:fMu">fMu</a> * otherN ;
	
	if ( otherL &lt;= <a href=".././TConsistency.html#TConsistency:fLikelihood">fLikelihood</a> &amp;&amp; nextL &gt; <a href=".././TConsistency.html#TConsistency:fLikelihood">fLikelihood</a> ) {
<b>	    // next bin is <a href=".././TConsistency.html#TConsistency:OK">OK</a></b>
	    otherN = nextN ;
	    break ;
	} else if ( otherL &gt; <a href=".././TConsistency.html#TConsistency:fLikelihood">fLikelihood</a> &amp;&amp; nextL &lt;= <a href=".././TConsistency.html#TConsistency:fLikelihood">fLikelihood</a> ) {
<b>	    // this bin is <a href=".././TConsistency.html#TConsistency:OK">OK</a></b>
	    break ;
	} else {
<b>	    // nope, continue then</b>
	    otherN = nextN ;
	    otherL = nextL ;
	}
    } 
    
<b>    // now we should be at the good bin</b>
    if ( otherN &gt; <a href=".././TPoissonConsistency.html#TPoissonConsistency:fNObs">fNObs</a> ) {
	<a href="../ListOfTypes.html#Double_t">Double_t</a> thisP = <a href=".././TNumRecipes.html#TNumRecipes:Gammq">TNumRecipes::Gammq</a> ( <a href=".././TPoissonConsistency.html#TPoissonConsistency:fNObs">fNObs</a>+1, <a href=".././TPoissonConsistency.html#TPoissonConsistency:fMu">fMu</a> ) ;
	<a href="../ListOfTypes.html#Double_t">Double_t</a> otherP = <a href=".././TNumRecipes.html#TNumRecipes:Gammp">TNumRecipes::Gammp</a> ( otherN+1, <a href=".././TPoissonConsistency.html#TPoissonConsistency:fMu">fMu</a> ) ;
	<a href=".././TConsistency.html#TConsistency:fValue">fValue</a> = otherP + thisP ;
    } else {
	<a href="../ListOfTypes.html#Double_t">Double_t</a> thisP = <a href=".././TNumRecipes.html#TNumRecipes:Gammp">TNumRecipes::Gammp</a> ( <a href=".././TPoissonConsistency.html#TPoissonConsistency:fNObs">fNObs</a>, <a href=".././TPoissonConsistency.html#TPoissonConsistency:fMu">fMu</a> ) ;
	<a href="../ListOfTypes.html#Double_t">Double_t</a> otherP = 0 ;
	if ( otherN &gt; 0 ) otherP = <a href=".././TNumRecipes.html#TNumRecipes:Gammq">TNumRecipes::Gammq</a> ( otherN, <a href=".././TPoissonConsistency.html#TPoissonConsistency:fMu">fMu</a> ) ;
	<a href=".././TConsistency.html#TConsistency:fValue">fValue</a> = otherP + thisP ;
    } 
    
}
</pre>

<!--SIGNATURE-->
<br>
<hr>
<center>
<address>
<a href="http://root.cern.ch/root/Welcome.html">ROOT page</a> - <a href="../ClassIndex.html">Class index</a> - <a href="#TopOfPage">Top of the page</a><br>
</address>
</center>
<hr>
<address>
This page has been automatically generated. If you have any comments or suggestions about the page layout send a mail to <a href="mailto:rootdev@root.cern.ch">ROOT support</a>, or contact <a href="mailto:rootdev@root.cern.ch">the developers</a> with any questions or problems regarding ROOT.
</address>
</body>
</html>
