<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<!--                                             -->
<!-- Author: ROOT team (rootdev@hpsalo.cern.ch)  -->
<!--                                             -->
<!--   Date: Fri Dec 20 16:02:00 2002            -->
<!--                                             -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>BtaFitParamsR_002 - source file</title>
<link rev=made href="mailto:rootdev@root.cern.ch">
<meta name="rating" content="General">
<meta name="objecttype" content="Manual">
<meta name="keywords" content="software development, oo, object oriented, unix, x11, windows, c++, html, rene brun, fons rademakers">
<meta name="description" content="ROOT - An Object Oriented Framework For Large Scale Data Analysis.">
</head>
<body BGCOLOR="#ffffff" LINK="#0000ff" VLINK="#551a8b" ALINK="#ff0000" TEXT="#000000">
<a name="TopOfPage"></a>
<pre>
<b>//--------------------------------------------------------------------------</b>
<b>// File and Version Information:</b>
<b>// 	$Id: BtaFitParamsR_002.cxx.html,v 1.1.1.1 2002-12-20 15:05:30 marcel Exp $</b>
<b>//</b>
<b>// Description:</b>
<b>//      Class <a href=".././BtaFitParamsR_002.html">BtaFitParamsR_002</a></b>
<b>//</b>
<b>// Environment:</b>
<b>//	Software developed for the BaBar Detector at the SLAC B-Factory.</b>
<b>//</b>
<b>// Author List:</b>
<b>//      Yury Kolomensky</b>
<b>//      Leif Wilden</b>
<b>//</b>
<b>// Copyright Information:</b>
<b>//	Copyright (C) 1999         Caltech</b>
<b>//</b>
<b>//------------------------------------------------------------------------</b>

<b>//-----------------------</b>
<b>// This Class's Header --</b>
<b>//-----------------------</b>
#include "KangaSchema/BtaFitParamsR_002.h"
#include "RhoBase/TFitParams.h"
#include "KangaSchema/ComPackFlatFloat.h"
#include "KangaSchema/ComPackNonFlatFloat.h"
#include "RhoMath/TError.h"

<b>//-------------</b>
<b>// C Headers --</b>
<b>//-------------</b>
#include &lt;assert.h&gt;

<b>//---------------</b>
<b>// C++ Headers --</b>
<b>//---------------</b>

<b>//-------------------------------</b>
<b>// Collaborating Class Headers --</b>
<b>//-------------------------------</b>

<b>//-----------------------------------------------------------------------</b>
<b>// Local Macros, Typedefs, Structures, Unions and Forward Declarations --</b>
<b>//-----------------------------------------------------------------------</b>
ClassImp(<a href=".././BtaFitParamsR_002.html">BtaFitParamsR_002</a>)

#include &lt;iostream&gt;
using namespace std;

<b>//----------------</b>
<b>// Constructors --</b>
<b>//----------------</b>

<a name="BtaFitParamsR_002:BtaFitParamsR_002"> </a><a href=".././BtaFitParamsR_002.html#BtaFitParamsR_002:BtaFitParamsR_002">BtaFitParamsR_002::BtaFitParamsR_002</a>() : 
  <a href=".././BtaFitParamsR_002.html#BtaFitParamsR_002:_q">_q</a>( 0 ) {

  <a href="../ListOfTypes.html#int">int</a> i= 0;
  for( i= 0; i &lt; 5; i++ ) <a href=".././BtaFitParamsR_002.html#BtaFitParamsR_002:_params">_params</a>[i]= 0;
  for( i= 0; i &lt; 15; i++ ) <a href=".././BtaFitParamsR_002.html#BtaFitParamsR_002:_diag">_diag</a>[i]= 0;
  for( i= 0; i &lt; 10; i++ ) <a href=".././BtaFitParamsR_002.html#BtaFitParamsR_002:_corr">_corr</a>[i]= 0;

}
/*
<a name="BtaFitParamsR_002:BtaFitParamsR_002"> </a><a href=".././BtaFitParamsR_002.html#BtaFitParamsR_002:BtaFitParamsR_002">BtaFitParamsR_002::BtaFitParamsR_002</a>( const BtaCandidate &amp; transient )
  : <a href=".././BtaFitParamsR_002.html#BtaFitParamsR_002:_q">_q</a>( transient.charge() ) {

  <a href="../ListOfTypes.html#int">int</a> i= 0;
  for( i= 0; i &lt; 5; i++ ) <a href=".././BtaFitParamsR_002.html#BtaFitParamsR_002:_params">_params</a>[i]= 0;
  for( i= 0; i &lt; 15; i++ ) <a href=".././BtaFitParamsR_002.html#BtaFitParamsR_002:_diag">_diag</a>[i]= 0;
  for( i= 0; i &lt; 10; i++ ) <a href=".././BtaFitParamsR_002.html#BtaFitParamsR_002:_corr">_corr</a>[i]= 0;

  if(fabs(<a href=".././BtaFitParamsR_002.html#BtaFitParamsR_002:_q">_q</a>)&gt;0.1){// helices
    TrkExchangePar par(transient.recoTrk()-&gt;fitResult()-&gt;helix(0));
    storeRotation(par.params(),par.covariance());
    
  }else{ // Neutrals
    
    HepVector v(4);
    v[0]=transient.fitParams().pos().x();
    v[1]=transient.fitParams().pos().y();
    v[2]=transient.fitParams().pos().z();
    v[3]=transient.fitParams().e();
    const HepSymMatrix&amp; cov7=transient.fitParams().cov7();
    HepSymMatrix m(4);
    for(<a href="../ListOfTypes.html#int">int</a> j=0;j&lt;3;j++){
      for(<a href="../ListOfTypes.html#int">int</a> k=0;k&lt;=j;k++)m[j][k]=cov7[j][k];
      m[j][3]=cov7[j][6];
    }
    m[3][3]=cov7[6][6];
    store(v,m);
  }

}
*/

<b>//--------------</b>
<b>// Destructor --</b>
<b>//--------------</b>

<a name="BtaFitParamsR_002:~BtaFitParamsR_002"> </a><a href=".././BtaFitParamsR_002.html">BtaFitParamsR_002</a>::~<a href=".././BtaFitParamsR_002.html">BtaFitParamsR_002</a>() {}

<b>//--------------------</b>
<b>// Member Functions --</b>
<b>//--------------------</b>

<a name="BtaFitParamsR_002:Transient"> </a>TFitParams* <a href=".././BtaFitParamsR_002.html#BtaFitParamsR_002:Transient">BtaFitParamsR_002::Transient</a>() const {

  <a href="../ListOfTypes.html#double">double</a> charge(<a href=".././BtaFitParamsR_002.html#BtaFitParamsR_002:_q">_q</a>);
  <a href="../ListOfTypes.html#Float_t">Float_t</a> *par = (<a href="../ListOfTypes.html#Float_t">Float_t</a> *) <a href=".././BtaFitParamsR_002.html#BtaFitParamsR_002:_params">_params</a>;
  <a href="../ListOfTypes.html#Float_t">Float_t</a> *cov = 0;

  if(fabs(charge)&lt;0.1){
      return new TFitParams(charge,par,cov);
  }else{
      cov = <a href="#BtaFitParamsR_002:LoadRotation">LoadRotation</a>();
      return new TFitParams(charge,par,cov);
  }

}
/*  
<a href="../ListOfTypes.html#void">void</a> <a href=".././BtaFitParamsR_002.html#BtaFitParamsR_002:print">BtaFitParamsR_002::print</a>( std::ostream &amp; ost ) const {

  ost &lt;&lt; "Charge: " &lt;&lt; <a href=".././BtaFitParamsR_002.html#BtaFitParamsR_002:_q">_q</a> &lt;&lt; endl;
  if (<a href=".././BtaFitParamsR_002.html#BtaFitParamsR_002:_q">_q</a>==0)
    ost &lt;&lt; "Cluster Position, Energy: (" &lt;&lt; <a href=".././BtaFitParamsR_002.html#BtaFitParamsR_002:_params">_params</a>[0] &lt;&lt; ", " &lt;&lt; <a href=".././BtaFitParamsR_002.html#BtaFitParamsR_002:_params">_params</a>[1] &lt;&lt; ", " &lt;&lt; <a href=".././BtaFitParamsR_002.html#BtaFitParamsR_002:_params">_params</a>[2] 
        &lt;&lt; ") E= " &lt;&lt; <a href=".././BtaFitParamsR_002.html#BtaFitParamsR_002:_params">_params</a>[3] &lt;&lt; endl;
  else
    ost &lt;&lt; "Track Parameters: " &lt;&lt; <a href=".././BtaFitParamsR_002.html#BtaFitParamsR_002:_params">_params</a>[0] &lt;&lt; ", " &lt;&lt; <a href=".././BtaFitParamsR_002.html#BtaFitParamsR_002:_params">_params</a>[1] &lt;&lt; ", " &lt;&lt; <a href=".././BtaFitParamsR_002.html#BtaFitParamsR_002:_params">_params</a>[2] &lt;&lt; ", "
        &lt;&lt; <a href=".././BtaFitParamsR_002.html#BtaFitParamsR_002:_params">_params</a>[3] &lt;&lt; ", " &lt;&lt; <a href=".././BtaFitParamsR_002.html#BtaFitParamsR_002:_params">_params</a>[4] &lt;&lt; endl;

}
*/
<b>// This code reads the schema 4 covariance matrices</b>

class ComFitRangePack{
private:
  <a href="../ListOfTypes.html#double">double</a> ranges[5][5];
public:
  ComFitRangePack(<a href="../ListOfTypes.html#int">int</a> chge){
    if(chge == 0){
      for(<a href="../ListOfTypes.html#int">int</a> j=0;j&lt;4;j++)ranges[j][j]=1e3;
    }else{
      ranges[0][0]=10;
      ranges[1][1]=1e-3;
      ranges[2][2]=1e-4;
      ranges[3][3]=1e3;
      ranges[4][4]=0.1;
    }
  }
  <a href="../ListOfTypes.html#double">double</a> range(<a href="../ListOfTypes.html#int">int</a> i,<a href="../ListOfTypes.html#int">int</a> j){return ranges[i][j];}
};


<a href="../ListOfTypes.html#Float_t">Float_t</a>*
<a name="BtaFitParamsR_002:LoadRotation"> </a><a href=".././BtaFitParamsR_002.html#BtaFitParamsR_002:LoadRotation">BtaFitParamsR_002::LoadRotation</a>() const {
    ComPackNonFlatFloat packer(ComPackNonFlatFloat::UNSIG);
<b>    //  ComPackNonFlatFloat packer8(ComPackNonFlatFloat::SIG);</b>
    ComPackFlatFloat packer8(-1,1,15);
    TVectorD eigenValues(5),angles(10);
    for(<a href="../ListOfTypes.html#Int_t">Int_t</a> j=0;j&lt;<a href="#BtaFitParamsR_002:nParm">nParm</a>();j++){
	if ( ! packer.unpackAndScream (0,10,<a href=".././BtaFitParamsR_002.html#BtaFitParamsR_002:_diag">_diag</a>[j],eigenValues(j),"DiagCov ") ) {
	    cerr &lt;&lt; " loadRotation: problems unpacking " &lt;&lt; "DiagCov " &lt;&lt; j &lt;&lt; endl ;
	}
	if(eigenValues(j)&lt;=0)eigenValues(j)=packer.getMinVal();
    }
    <a href="../ListOfTypes.html#Int_t">Int_t</a> nc = <a href="#BtaFitParamsR_002:nCorr">nCorr</a>();
    for(<a href="../ListOfTypes.html#Int_t">Int_t</a> j2=0;j2&lt;nc;j2++) {
<b>	// if ( ! packer8.unpackAndScream (-1.1,1.1,<a href=".././BtaFitParamsR_002.html#BtaFitParamsR_002:_diag">_diag</a>[<a href="#BtaFitParamsR_002:nParm">nParm</a>()+j2],angles(j2),"Corr") ) {</b>
<b>	//   cerr &lt;&lt; " loadRotation: problems unpacking " &lt;&lt; "Corr" &lt;&lt; j &lt;&lt; j2 &lt;&lt; endl ;</b>
<b>	// }</b>
	packer8.unpack(<a href=".././BtaFitParamsR_002.html#BtaFitParamsR_002:_diag">_diag</a>[<a href="#BtaFitParamsR_002:nParm">nParm</a>()+j2],angles(j2));
    }
    
    return <a href="#BtaFitParamsR_002:ComPackedCovariance">ComPackedCovariance</a>(eigenValues,angles);
}

<a name="BtaFitParamsR_002:ComPackedCovariance"> </a><a href="../ListOfTypes.html#Float_t">Float_t</a>* <a href=".././BtaFitParamsR_002.html#BtaFitParamsR_002:ComPackedCovariance">BtaFitParamsR_002::ComPackedCovariance</a>(const TVectorD&amp; eigenValues,const TVectorD&amp; angles) const
{
    static <a href="../ListOfTypes.html#Float_t">Float_t</a> _cov[15];
    <a href="../ListOfTypes.html#int">int</a> nDim=5;
    assert (eigenValues.GetNrows() == nDim);
    assert (angles.GetNrows() == 2*nDim);
<b>    // restore the diagonal part</b>
    <a href=".././TError.html">TError</a> diag(nDim);
    diag.Zero();
    for(<a href="../ListOfTypes.html#int">int</a> l=0;l&lt;nDim;l++)diag(l,l)=eigenValues(l);
<b>    // build up the rotation</b>
    TMatrixD rot(nDim,nDim);
    rot = 1.;
    for(<a href="../ListOfTypes.html#int">int</a> i=nDim-1;i&gt;0;i--){
	for(<a href="../ListOfTypes.html#int">int</a> j=i+1;j&lt;=nDim;j++){
	    <a href="../ListOfTypes.html#double">double</a> phi=angles( j*(j-1)/2-i)*TMath::Pi();
	    <a href="../ListOfTypes.html#double">double</a> co = TMath::Cos(phi);
	    <a href="../ListOfTypes.html#double">double</a> si = TMath::Sin(phi);
	    for (<a href="../ListOfTypes.html#int">int</a> k=1;k&lt;=nDim;k++){
		<a href="../ListOfTypes.html#double">double</a> a1 = co*rot(k-1,j-1)-si*rot(k-1,j-1);
		<a href="../ListOfTypes.html#double">double</a> a2 = si*rot(k-1,j-1)+co*rot(k-1,j-1);
		rot(k-1,j-2) = a1;
		rot(k-1,j-1) = a2;
	    }
	}
    }

<b>    //HepSymMatrix result(diag.similarity(rot));</b>
    TMatrixD result(diag.Similarity(rot));
    
    <a href="../ListOfTypes.html#int">int</a> n= 0;
    for( <a href="../ListOfTypes.html#int">int</a> row= 1; row &lt; 6; row++ ) {
	for( <a href="../ListOfTypes.html#int">int</a> col= 1; col &lt;= row; col++ ) {
	    _cov[n]= result( row-1, col-1 );
	    n++;
	}
    }

    return _cov;
    
}
</pre>

<!--SIGNATURE-->
<br>
<hr>
<center>
<address>
<a href="http://root.cern.ch/root/Welcome.html">ROOT page</a> - <a href="../ClassIndex.html">Class index</a> - <a href="#TopOfPage">Top of the page</a><br>
</address>
</center>
<hr>
<address>
This page has been automatically generated. If you have any comments or suggestions about the page layout send a mail to <a href="mailto:rootdev@root.cern.ch">ROOT support</a>, or contact <a href="mailto:rootdev@root.cern.ch">the developers</a> with any questions or problems regarding ROOT.
</address>
</body>
</html>
